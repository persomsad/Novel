# v0.2.0 Milestone – 连续创作与一致性升级

## 核心目标

在 MVP 基础上，交付面向长篇网络小说的“连续创作”体验：

- **记忆可靠**：会话可恢复、章节/设定可检索，Agent 不再遗忘设定。
- **一致性可证**：时间线 / 引用脚本真的会报错，Agent 输出包含精确行号 + 修复建议。
- **流程可控**：章节写作 → 校验 → 修订成为可重复的编排流程，CLI/Web 均可触发。

**完成标准**

- 所有 P0 Issue 完成并通过端到端测试。
- `novel-agent chat --session <id>` 可以恢复历史对话，`novel-agent check` 输出脚本详情。
- `just ci` 全绿，覆盖率 ≥ 75%，文档同步更新（README、ADR、工具规格）。

**预计时间**：1–2 周（取决于脚本与记忆实现复杂度）

---

## P0 Issue 清单（阻塞发布）

### #12: 构建连续创作索引
**描述**：将章节 / 设定解析为统一的连续性索引，供 Agent 与脚本共享。

**验收标准**：
- [ ] 新增 `data/continuity/index.json`，包含章节→角色→时间标记→引用 ID 的映射。
- [ ] 提供 `novel-agent refresh-memory` 命令或脚本，能重建索引。
- [ ] README 记录索引结构与刷新流程。

**Dependencies**: None

### #13: 实现严格校验脚本
**描述**：补齐 `verify_strict_timeline` / `verify_strict_references` TODO，让脚本真正检查数据。

**验收标准**：
- [ ] `verify_strict_timeline()` 能解析 `[TIME:YYYY-MM-DD]`，检测乱序/跳日/缺失，输出机器可读 JSON。
- [ ] `verify_strict_references()` 能校验 `[REF:token]` 是否在索引中注册，列出缺失与未回收伏笔。
- [ ] `tests/test_consistency_validation.py` 增加表驱动用例（包含正例 + 负例）。
- [ ] CLI `novel-agent check` 在检测到错误时显示行号+修复建议。

**Dependencies**: #12

### #14: 会话持久化与 NervusDB 记忆接入
**描述**：把 LangGraph `SqliteSaver` 接入 CLI / Agent，并引入 NervusDB 作为长期事实与时间线存储，取代传统向量检索。

- [ ] `.novel-agent/state.sqlite` 自动创建并由 `create_specialized_agent` 使用。
- [ ] `novel-agent chat --session <id>` 可以复用同一 `thread_id`，并提供 `novel-agent sessions --list/--delete` 辅助命令。
- [ ] `novel-agent memory ingest --db <path>` 通过 Nervus CLI 写入角色/章节/时间线/引用，可配合 `--dry-run`/`--no-refresh`。
- [ ] `tests/test_persistence.py` 增补“写入→读取”验证，确保会话可恢复，并新增 NervusDB ingest/查询集成测试。
- [ ] README / docs/memory-cli.md 更新“会话管理 & NervusDB”章节，描述部署、同步、查询流程。

**Dependencies**: #12

### #15: LangGraph 编排与 CLI 流程
**描述**：把“章节写作 / 一致性稽核”流程固化为 LangGraph Workflow，CLI 直接触发。

**验收标准**：
- [ ] LangGraph 中定义 `chapter_workflow`（检索 → 规划 → 草稿 → 脚本检查 → 输出）。
- [ ] CLI 新增 `novel-agent run --workflow chapter`，支持传入大纲/需求，执行完整流程。
- [ ] Workflow 可以配置 Agent（default / continuity-editor），并自动调用 P0 脚本。
- [ ] `tests/test_e2e.py` 新增完整流程用例，验证输出含脚本结果。

**Dependencies**: #13, #14

### #16: NervusDB Gateway 服务
**描述**：提供独立的 Node Gateway（HTTP/Unix Socket + CLI 工具），封装 `@nervusdb/core` 的打开、查询、时间线、本地运维能力。

**验收标准**：
- [ ] `services/nervusdb` 目录包含 pnpm workspace、TypeScript 源码与 Vitest 覆盖。
- [ ] 暴露 `POST /facts/ingest`、`POST /timeline/query`、`POST /graph/query` 等接口，所有输入做 schema 校验与日志记录。
- [ ] 提供 CLI：`pnpm memory:dev`（启动服务）、`pnpm memory:check`（运行 nervusdb check/stats）、`pnpm memory:compact`（触发 auto-compact/gc）。
- [ ] README / docs/memory.md 记录服务配置项（数据库路径、锁、压缩、插件）。
- [ ] CI 中可在 1 分钟内启动并完成 smoke test。

**Dependencies**: #12

### #17: 一致性脚本对比 NervusDB
**描述**：让时间线/引用脚本在解析 Markdown 之后，与 NervusDB 查询结果进行对比，输出“章节 vs 事实库”的差异报告。

**验收标准**：
- [ ] `verify_strict_timeline` 读取 NervusDB 时间线（通过 gateway 工具），若章节事件不在事实库中或顺序不同，给出详细 diff。
- [ ] `verify_strict_references` 校验 NervusDB 中是否存在引用实体/事件，缺失则报错。
- [ ] `tests/test_consistency_validation.py` 增加覆盖 NervusDB 对比的单元/集成测试（使用临时数据库）。
- [ ] CLI `novel-agent check` 在校验报告中追加 NervusDB 差异摘要。

**Dependencies**: #13, #14, #16

---

## P1 Issue 清单（重要但可顺延）

### #18: 多 Agent 提示词升级
- 扩展 `AGENT_CONFIGS`，新增 `continuity-editor`、`style-smith`，引入“思考-规划-草稿-修订”流程。
- 文档：更新 `docs/tools-specification.md` 与 ADR，说明不同 Agent 的职责与工具。

### #19: 创作辅助工具包
- 实现 `calculate_word_count`、`random_name_generator`、`style_analyzer`、`dialogue_enhancer`、`plot_twist_generator` 等函数。
- 每个工具附单测 + README 示例；为需要参数的工具设计 Typer 子命令或 Agent Tool。

### #20: 轻量 Web/TUI 面板
- 原型一个最小的 Streamlit 或 Textual 控制台，展示章节、设定、脚本报告。
- 与 CLI 共享同一后端（通过 CLI 命令或 Python API）。

### #21: 文档与 ADR
- 更新 `docs/architecture/index.md`、新增 ADR（记忆架构 / Workflow 设计）。
- README 新增“连续创作流程”“会话管理”章节。

---

## 验证清单

- [ ] 人工制造时间线 / 引用错误，`novel-agent check` 能输出行号、问题描述、修复建议。
- [ ] `novel-agent chat --session hero-arc`：两轮对话后退出，再次使用同 session，Agent 会引用上一轮上下文。
- [ ] `novel-agent run --workflow chapter --outline spec/outline.md`：日志中显示检索到的设定/章节，输出包含脚本结果。
- [ ] `just ci` 全绿；新增覆盖率 ≥ 75%，并在 PR 模板中引用该里程碑。

---

## 进度追踪

| Issue | 状态 | 负责人 | 预计时间 |
|-------|------|--------|---------|
| #12 连续性索引 | ⏳ 待开始 | - | - |
| #13 严格校验脚本 | ⏳ 待开始 | - | - |
| #14 会话持久化 | ⏳ 待开始 | - | - |
| #15 LangGraph 编排 | ⏳ 待开始 | - | - |
| #16 NervusDB Gateway | ⏳ 待开始 | - | - |
| #17 脚本对比 NervusDB | ⏳ 待开始 | - | - |
| #18 Agent 提示词 | ⏳ 待开始 | - | - |
| #19 工具包 | ⏳ 待开始 | - | - |
| #20 Web/TUI 面板 | ⏳ 待开始 | - | - |
| #21 文档 & ADR | ⏳ 待开始 | - | - |

---

## 下一步

1. 将 GitHub Milestone `v0.2.0` 与上述 Issue 对齐（缺失的 Issue 逐个创建并关联）。
2. 先完成 P0：索引 → 脚本 → 记忆 → Workflow，确保 Agent 输出可信。
3. 之后再迭代 P1（多 Agent、工具包、界面与文档）。
