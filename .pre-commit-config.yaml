# Pre-commit hooks for novel-agent project
#
# å®‰è£…ï¼š
#   pre-commit install           # å¯ç”¨ commit hook
#   pre-commit install --hook-type pre-push  # å¯ç”¨ push hook
#
# å·¥ä½œæµç¨‹ï¼š
#   git commit  â†’ è‡ªåŠ¨æ ¼å¼åŒ– + è‡ªåŠ¨ä¿®å¤lint + ç±»åž‹æ£€æŸ¥
#   git push    â†’ è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆå¿…é¡»é€šè¿‡ï¼‰
#
# è·³è¿‡hooksï¼ˆç´§æ€¥æƒ…å†µï¼Œä¸æŽ¨èï¼‰ï¼š
#   git commit --no-verify
#   git push --no-verify

repos:
  # ========== Commit é˜¶æ®µï¼šè‡ªåŠ¨ä¿®å¤é—®é¢˜ ==========

  # 1. åŸºç¡€æ¸…ç†ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace      # ç§»é™¤è¡Œå°¾ç©ºæ ¼
      - id: end-of-file-fixer         # ç¡®ä¿æ–‡ä»¶ä»¥æ¢è¡Œç¬¦ç»“å°¾
      - id: check-yaml                # æ£€æŸ¥YAMLè¯­æ³•
      - id: check-added-large-files   # é˜²æ­¢æäº¤å¤§æ–‡ä»¶
        args: ['--maxkb=1000']
      - id: check-merge-conflict      # æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°
      - id: mixed-line-ending         # ç»Ÿä¸€æ¢è¡Œç¬¦
        args: ['--fix=lf']

  # 2. Pythonä»£ç æ ¼å¼åŒ–ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        name: "ðŸŽ¨ Black (auto-format code)"
        stages: [pre-commit]

  # 3. Python Lint + è‡ªåŠ¨ä¿®å¤
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.4
    hooks:
      - id: ruff
        name: "ðŸ”§ Ruff (auto-fix lint issues)"
        args: ['--fix', '--exit-non-zero-on-fix']
        stages: [pre-commit]
      - id: ruff-format
        name: "ðŸŽ¨ Ruff (format imports)"
        stages: [pre-commit]

  # 4. ç±»åž‹æ£€æŸ¥ï¼ˆä»…æ£€æŸ¥ï¼Œä¸ä¿®å¤ï¼‰
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.14.0
    hooks:
      - id: mypy
        name: "ðŸ” Mypy (type check)"
        stages: [pre-commit]
        additional_dependencies:
          - types-requests

  # ========== Push é˜¶æ®µï¼šç¡®ä¿è´¨é‡ ==========

  - repo: local
    hooks:
      # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      - id: pytest
        name: "ðŸ§ª Pytest (run all tests)"
        entry: poetry run pytest --tb=short
        language: system
        pass_filenames: false
        stages: [pre-push]
        verbose: true

      # ç¡®ä¿æµ‹è¯•è¦†ç›–çŽ‡è¾¾æ ‡
      - id: coverage-check
        name: "ðŸ“Š Coverage Check (>50%)"
        entry: bash -c 'poetry run pytest --cov=src --cov-report=term --cov-fail-under=50 --quiet'
        language: system
        pass_filenames: false
        stages: [pre-push]
        verbose: true
